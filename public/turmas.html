<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gestão de Turmas</title>
    <link rel="stylesheet" href="./stylesheets/style.css">
</head>
<body>
    <nav>
        <ul>
            <li><a href="aluno.html">Alunos</a></li>
            <li><a href="disciplinas.html">Disciplinas</a></li>
            <li><a href="professores.html">Professores</a></li>
            <li><a href="salas.html">Salas</a></li>
            <li><a href="turmas.html">Turmas</a></li>
        </ul>
    </nav>
    <main>
        <h2>Gerenciar Turmas</h2>

        <section id="tela-turmas">
            <h3>Lista de Turmas</h3>
            <form id="formTurma">
                <label>Código</label>
                <input type="text" id="codigo" required>
                <label>Ano Letivo</label>
                <input type="number" id="ano_letivo" required>
                <label>Sala</label>
                <select id="sala_id" required>
                    <option value="">Carregando...</option>
                </select>
                <button type="submit">Criar Turma</button>
            </form>
            <br>
            <table>
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Ano</th>
                        <th>Sala</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tbTurmas"></tbody>
            </table>
        </section>

        <section id="tela-alunos" class="hidden">
            <h3>Alunos da Turma: <span id="tituloTurma"></span></h3>
            <button onclick="voltarParaTurmas()">Voltar</button>
            <br><br>
            
            <form id="formMatricula">
                <label>Matricular Aluno</label>
                <select id="selectAlunosParaMatricula"></select>
                <button type="submit">Matricular</button>
            </form>
            <br>
            <table>
                <thead>
                    <tr>
                        <th>Nome do Aluno</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tbAlunosTurma"></tbody>
            </table>
        </section>

        <section id="tela-notas" class="hidden">
            <h3>Notas de: <span id="tituloAluno"></span></h3>
            <button onclick="voltarParaAlunos()">Voltar</button>
            <br><br>

            <form id="formNota">
                <label>Disciplina</label>
                <select id="selectDisciplinaNota"></select>
                <label>Nota (0-10)</label>
                <input type="number" id="valorNota" step="0.1" required>
                <button type="submit">Lançar Nota</button>
            </form>
            <br>
            <table>
                <thead>
                    <tr>
                        <th>Disciplina</th>
                        <th>Nota</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tbNotas"></tbody>
            </table>
        </section>
    </main>

    <script>
        const API = 'http://localhost:3000';
        let turmaAtual = null;
        let alunoAtual = null;

        window.onload = () => {
            listarTurmas();
            carregarSalas();
        };

        
        function mostrarTela(idTela) {
            
            ['tela-turmas', 'tela-alunos', 'tela-notas'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(idTela).classList.remove('hidden');
        }

        function voltarParaTurmas() { mostrarTela('tela-turmas'); }
        function voltarParaAlunos() { mostrarTela('tela-alunos'); }

       
        async function listarTurmas() {
            const res = await fetch(`${API}/turmas/consultar`);
            const dados = await res.json();
            const tb = document.getElementById('tbTurmas');
            tb.innerHTML = '';
            dados.forEach(t => {
                const sala = t.bloco ? `Bl.${t.bloco}-${t.numero}` : 'Sem Sala';
                tb.innerHTML += `
                    <tr>
                        <td>${t.codigo}</td>
                        <td>${t.ano_letivo}</td>
                        <td>${sala}</td>
                        <td>
                            <button onclick="abrirAlunos(${t.id}, '${t.codigo}')">Ver Alunos</button>
                            <button onclick="excluirTurma(${t.id})">Excluir</button>
                        </td>
                    </tr>`;
            });
        }

        async function carregarSalas() {
            const res = await fetch(`${API}/salas/consultar`);
            const dados = await res.json();
            const sel = document.getElementById('sala_id');
            sel.innerHTML = '<option value="">Selecione...</option>';
            dados.forEach(s => sel.innerHTML += `<option value="${s.id}">Bl. ${s.bloco} - ${s.numero}</option>`);
        }

        document.getElementById('formTurma').onsubmit = async (e) => {
            e.preventDefault();
            await fetch(`${API}/turmas/inserir`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    codigo: document.getElementById('codigo').value,
                    ano_letivo: document.getElementById('ano_letivo').value,
                    sala_id: document.getElementById('sala_id').value
                })
            });
            listarTurmas();
            document.getElementById('formTurma').reset();
        };

    
        async function abrirAlunos(id, codigo) {
            turmaAtual = id;
            document.getElementById('tituloTurma').innerText = codigo;
            mostrarTela('tela-alunos');
            listarAlunosDaTurma();
            carregarSelectAlunos();
        }

        async function listarAlunosDaTurma() {
            const res = await fetch(`${API}/matriculas/consultar?turma_id=${turmaAtual}`);
            const dados = await res.json();
            const tb = document.getElementById('tbAlunosTurma');
            tb.innerHTML = '';
            
            if(dados.message) return; 

            dados.forEach(m => {
                tb.innerHTML += `
                    <tr>
                        <td>${m.nome}</td>
                        <td>
                            <button onclick="abrirNotas(${m.aluno_id}, '${m.nome}')">Notas</button>
                            <button onclick="cancelarMatricula(${m.aluno_id})">Remover</button>
                        </td>
                    </tr>`;
            });
        }

        async function carregarSelectAlunos() {
            const res = await fetch(`${API}/aluno/consultar`);
            const dados = await res.json();
            const sel = document.getElementById('selectAlunosParaMatricula');
            sel.innerHTML = '';
            dados.forEach(a => sel.innerHTML += `<option value="${a.id}">${a.nome}</option>`);
        }

        document.getElementById('formMatricula').onsubmit = async (e) => {
            e.preventDefault();
            await fetch(`${API}/matriculas/inserir`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ aluno_id: document.getElementById('selectAlunosParaMatricula').value, turma_id: turmaAtual })
            });
            listarAlunosDaTurma();
        }

       
        async function abrirNotas(id, nome) {
            alunoAtual = id;
            document.getElementById('tituloAluno').innerText = nome;
            mostrarTela('tela-notas');
            listarNotasDoAluno();
            carregarDisciplinas();
        }

        async function listarNotasDoAluno() {
            const res = await fetch(`${API}/notas/consultar?aluno_id=${alunoAtual}&turma_id=${turmaAtual}`);
            const dados = await res.json();
            const tb = document.getElementById('tbNotas');
            tb.innerHTML = '';
            if(dados.message) return;

            dados.forEach(n => {
                tb.innerHTML += `
                    <tr>
                        <td>${n.nome}</td> <td>${n.nota}</td>
                        <td><button onclick="excluirNota(${n.id})">Excluir</button></td>
                    </tr>`;
            });
        }

        async function carregarDisciplinas() {
            const res = await fetch(`${API}/disciplinas/consultar`);
            const dados = await res.json();
            const sel = document.getElementById('selectDisciplinaNota');
            sel.innerHTML = '';
            dados.forEach(d => sel.innerHTML += `<option value="${d.id}">${d.nome}</option>`);
        }

        document.getElementById('formNota').onsubmit = async (e) => {
            e.preventDefault();
            await fetch(`${API}/notas/inserir`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    aluno_id: alunoAtual, 
                    turma_id: turmaAtual, 
                    disciplina_id: document.getElementById('selectDisciplinaNota').value,
                    nota: document.getElementById('valorNota').value 
                })
            });
            listarNotasDoAluno();
            document.getElementById('valorNota').value = '';
        }

        async function excluirNota(id) {
            await fetch(`${API}/notas/excluir?id=${id}`, { method: 'DELETE' });
            listarNotasDoAluno();
        }
        
        async function excluirTurma(id) {
             await fetch(`${API}/turmas/excluir?id=${id}`, { method: 'DELETE' });
             listarTurmas();
        }
        
        async function cancelarMatricula(idAluno) {
             await fetch(`${API}/matriculas/cancelar?aluno_id=${idAluno}&turma_id=${turmaAtual}`, { method: 'DELETE' });
             listarAlunosDaTurma();
        }
    </script>
</body>
</html>